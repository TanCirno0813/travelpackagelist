<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ëŠ¥ì§€ ê²Œì„</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #1e1e2f;
      color: #fff;
      text-align: center;
      padding-top: 50px;
    }
    .btn-option {
      margin: 10px;
      width: 100px;
      height: 50px;
      font-size: 20px;
    }
    .progress {
      height: 20px;
      margin: 20px;
      background-color: #555;
    }
    .progress-bar {
      transition: width 0.1s linear;
    }
  </style>
</head>
  <body>
<h1>ğŸ§® ëŠ¥ì§€ ê²Œì„</h1>
<p id="score" class="mt-3">Score: 0</p>
<p id="timer" class="mt-2">â° ì œí•œì‹œê°„: 10ì´ˆ</p>

<div class="progress mx-auto" style="width: 50%;">
  <div id="timeBar" class="progress-bar bg-warning" role="progressbar" style="width: 100%;"></div>
</div>

<p id="question" class="mt-4 fs-3"></p>
<div id="options" class="d-flex justify-content-center flex-wrap mt-3"></div>

<!-- ğŸ® ê²Œì„ ë£° ì•ˆë‚´ ëª¨ë‹¬ -->
<div class="modal fade" id="ruleModal" tabindex="-1" aria-labelledby="ruleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="ruleModalLabel">ğŸ¯ ê²Œì„ ê·œì¹™</h5>
      </div>
      <div class="modal-body text-start">
        <ul>
          <li>ê³„ì‚°ì‹ì„ ë³´ê³  ë‹µì•ˆì„ ì„ íƒí•˜ì„¸ìš”.</li>
          <li><strong>ì •ë‹µì´ 9ì¸ ê²½ìš°</strong> â†’ <span class="text-warning">ì •ë‹µì„ ì„ íƒí•´ì•¼ ì ìˆ˜ +1</span></li>
          <li><strong>ì •ë‹µì´ 9ê°€ ì•„ë‹ ê²½ìš°</strong> â†’ <span class="text-warning">ì¼ë¶€ëŸ¬ í‹€ë¦° ë‹µì„ ì„ íƒí•´ì•¼ ì ìˆ˜ +1</span></li>
          <li>ì •ë‹µ ì„ íƒ ì‹¤ìˆ˜ ë˜ëŠ” ì œí•œì‹œê°„ ì´ˆê³¼ ì‹œ ê²Œì„ ì˜¤ë²„!</li>
          <li>ìŠ¤ì½”ì–´ê°€ ë†’ì•„ì§ˆìˆ˜ë¡ ì œí•œì‹œê°„ì´ ì ì  ì§§ì•„ì§‘ë‹ˆë‹¤.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" data-bs-dismiss="modal">ê²Œì„ ì‹œì‘!</button>
      </div>
    </div>
  </div>
</div>

<script>
  let score = 0;
  let timeLimit = 10;
  let timer;
  let timeLeft;
  let interval;

  async function loadQuestion() {
    clearTimeout(timer);
    clearInterval(interval);

    const res = await fetch("/api/game/question");
    const question = await res.json();
    document.getElementById("question").innerText = question.question;
    const buttons = document.getElementById("options");
    buttons.innerHTML = "";
    question.options.forEach(option => {
      const btn = document.createElement("button");
      btn.innerText = option;
      btn.className = "btn btn-warning btn-option";
      btn.onclick = () => submitAnswer(question.question, option);
      buttons.appendChild(btn);
    });

    timeLimit = Math.max(3, 10 - score * 0.5);
    document.getElementById("timer").innerText = `â° ì œí•œì‹œê°„: ${timeLimit.toFixed(1)}ì´ˆ`;
    startTimer(timeLimit);
  }

  function startTimer(limit) {
    timeLeft = limit;
    const bar = document.getElementById("timeBar");
    bar.style.width = "100%";

    interval = setInterval(() => {
      timeLeft -= 0.1;
      const percent = (timeLeft / limit) * 100;
      bar.style.width = `${percent}%`;
      if (timeLeft <= 0) {
        clearInterval(interval);
      }
    }, 100);

    timer = setTimeout(() => {
      window.location.href = `/game/over?score=${score}`;
    }, limit * 1000);
  }

  async function submitAnswer(question, selected) {
    clearTimeout(timer);
    clearInterval(interval);
    const res = await fetch("/api/game/check", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: question, selected: selected, score: score })
    });
    const result = await res.json();
    if (result) {
      score++;
      document.getElementById("score").innerText = "Score: " + score;
      loadQuestion();
    } else {
      window.location.href = "/game/over?score=" + score;
    }
  }

  window.onload = () => {
    const modal = new bootstrap.Modal(document.getElementById('ruleModal'));
    modal.show();
    modal._element.addEventListener('hidden.bs.modal', function () {
      loadQuestion();
    });
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
